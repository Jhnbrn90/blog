<!DOCTYPE html>
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html lang="en">
<!--<![endif]-->
	<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="author" content="John Braun">


        <title>John Braun // Blog - How to use fake dates in Cypress end-to-end testing</title>

        <!-- FAVICON -->
        <!-- CSS -->
        <link rel="stylesheet" href="https://johnbraun.nl/theme/css/style.css">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">

        <!-- Custom CSS -->
        	<link rel="stylesheet" href="https://johnbraun.nl/theme/css/colors/blue.css" id="colors">

        <!-- Code highlight color scheme -->
            <link href="https://johnbraun.nl/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->




    <meta property="og:type" content="article">
    <meta property="og:title" content="How to use fake dates in Cypress end-to-end testing">
    <meta property="og:url" content="how-to-use-fake-dates-in-cypress-end-to-end-testing.html">
    <meta property="og:description" content="When writing an end-to-end test (or so called browser test), it might be tricky to force the application to use a certain (fake) date. In this post, I share my approach using a custom middleware to be able to write Cypress tests while your application is in a specific (fake) date.">
    <meta property="article:published_time" content="Monday, September 07, 2020">
    <meta name="twitter:title" content="How to use fake dates in Cypress end-to-end testing">
    <meta name="twitter:description" content="When writing an end-to-end test (or so called browser test), it might be tricky to force the application to use a certain (fake) date. In this post, I share my approach using a custom middleware to be able to write Cypress tests while your application is in a specific (fake) date.">
    <meta name="description" content="When writing an end-to-end test (or so called browser test), it might be tricky to force the application to use a certain (fake) date. In this post, I share my approach using a custom middleware to be able to write Cypress tests while your application is in a specific (fake) date.">
    <meta name="twitter:image" content="posts/fake-dates-in-end-to-end-browser-tests/cover.jpeg">
    <meta property="og:image" content="posts/fake-dates-in-end-to-end-browser-tests/cover.jpeg">
	          <meta property="og:locale" content="">
			<meta property="og:site_name" content="John Braun // Blog">

	<meta property="og:type" content="article">
	<meta property="article:author" content="">
	<meta property="og:url" content="https://johnbraun.nl/how-to-use-fake-dates-in-cypress-end-to-end-testing.html">
	<meta property="og:title" content="How to use fake dates in Cypress end-to-end testing">
	<meta property="og:description" content="">
       <meta property="og:image" content="https://johnbraun.nl/posts/fake-dates-in-end-to-end-browser-tests/cover.jpeg">
	<meta property="article:published_time" content="2020-09-07 00:00:00+02:00">
	</head>
	<body>
		<header id="header">
			<!-- Container -->
			<div class="container">
				<!-- Logo / Mobile Menu -->
				<div class="five columns">
					<div id="textlogo">
						<h1><a href="https://johnbraun.nl/">John Braun // Blog</a></h1>
					</div>
				</div>
						<!-- Navigation
				================================================== -->
				<div class="eleven columns">

					<nav id="navigation" class="menu">
						<ul id="responsive">

							<li><a href="https://johnbraun.nl/">Home</a></li>


							        <li><a href="https://johnbraun.nl/pages/about.html">About</a></li>
						</ul>
					</nav>
				</div>
			</div>
			<!-- Container / End -->
		</header>
		<!-- Header / End -->

		<!-- Breadcrumbs Container-->
		<div id="content-wrapper">
			<section id="titlebar">
				<!-- Container -->
				<div class="container">
				<div class="thirteen columns">
					<nav id="breadcrumbs">
						<ul>
							<li>You are here:</li>
							<li><a href="https://johnbraun.nl/">Home</a></li>
<li>How to use fake dates in Cypress end-to-end testing</li>
						</ul>
					</nav>
				</div>
				</div>
				<!-- Container / End -->
			</section>

			<div class="container">
        <div class="twelve alt columns">
<article class="post" style="margin: 0; border: 0;">
	<section class="post-content">
		<header class="meta">
            <h2>
                <a href="https://johnbraun.nl/how-to-use-fake-dates-in-cypress-end-to-end-testing.html">How to use fake dates in Cypress end-to-end testing</a>
            </h2>
			<ul>
				<li>Published: 07-09-2020</li>
			</ul>
		</header>

		<h2>Introduction</h2>
<p>Recently, I wanted to write a <a href="https://cypress.io">Cypress</a> acceptance ("end-to-end") test for a Laravel project where I wanted <code>Carbon::now()</code> to return a specific (fake) date, so I could act as if it were that specific date in my browser test.</p>
<p>Initially, I thought I could just set <code>Carbon::setTestNow()</code>, however this would only survive a single request and I wanted the custom date I specified to be applied globally in the application to make assertions about several endpoints within these tests.</p>
<p>After a few online searches, I decided to ask for help <a href="https://twitter.com/JhnBrn90/status/1302680650860855297">on Twitter</a> and got a reply from <a href="https://twitter.com/sasin91">@sasin91</a> which sparked a new idea: perhaps I could use a middleware 💡.</p>
<p>Eventually, I ended up using the following setup.</p>
<h2>The middleware approach</h2>
<h3>Adding a new middleware</h3>
<p>First, I created a new middleware called <code>SetTestDate</code>. We want to apply this middleware within the 'web' middleware group, but only when the environment is either "local" (the default dev environment) or "testing" (the environment in <code>.env.cypress</code>). </p>
<p>Let's first conditionally push our middleware to the 'web' group within the <code>boot()</code> method of the <code>AppServiceProvider</code> as shown below.</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="c1">// app/Providers/AppServiceProvider.php</span>

<span class="k">use</span> <span class="nx">App\Http\Middleware\SetTestDate</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Contracts\Http\Kernel</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\ServiceProvider</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AppServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">environment</span><span class="p">([</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;testing&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$kernel</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">Kernel</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
            <span class="nv">$kernel</span><span class="o">-&gt;</span><span class="na">appendMiddlewareToGroup</span><span class="p">(</span><span class="s1">&#39;web&#39;</span><span class="p">,</span> <span class="nx">SetTestDate</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Within the <code>SetTestDate</code> middleware, we want to check if a certain cookie ("set_test_date" in this example) is set containing the specified (fake) date. For clarity and consistency let's store the name of this cookie in a class constant <code>TEST_DATE_COOKIE</code>. </p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="c1">// app/Http/Middleware/SetTestDate.php</span>

<span class="k">namespace</span> <span class="nx">App\Http\Middleware</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Carbon\Carbon</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Closure</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SetTestDate</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">TEST_DATE_COOKIE</span> <span class="o">=</span> <span class="s1">&#39;set_test_date&#39;</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nx">Closure</span> <span class="nv">$next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wantsToSetTestDate</span><span class="p">(</span><span class="nv">$request</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setDateNow</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">cookie</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">TEST_DATE_COOKIE</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">setDateNow</span><span class="p">(</span><span class="nv">$date</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">Carbon</span><span class="o">::</span><span class="na">setTestNow</span><span class="p">(</span><span class="nx">Carbon</span><span class="o">::</span><span class="na">parse</span><span class="p">(</span><span class="nv">$date</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">wantsToSetTestDate</span><span class="p">(</span><span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">cookie</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">TEST_DATE_COOKIE</span><span class="p">)</span> <span class="o">!==</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3>Setting a custom (fake) date in the Cypress test</h3>
<p>Now that we have our middleware in place, we can use the request variable we defined in our middleware to visit a route which uses the fake date. </p>
<div class="highlight"><pre><span></span><code><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;shows the current date&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;tuesday 1 september 2020&#39;</span>
<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">setCookie</span><span class="p">(</span><span class="s1">&#39;set_test_date&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">date</span><span class="p">);</span>

<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="nx">cy</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">&#39;Tuesday, September 1st 2020&#39;</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>

<h3>Encrypted cookies</h3>
<p>If you'd run the test at this stage, no cookie will be resolved from the request and <code>null</code> will be returned for <code>$request-&gt;cookie('set_test_date')</code>.</p>
<p>Since Laravel encrypts the cookies by default due to the <code>EncryptCookies</code> middleware, we need to create an exception for the <code>set_test_date</code> cookie. </p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="c1">// app/Http/Middleware/EncryptCookies.php</span>

<span class="k">class</span> <span class="nc">EncryptCookies</span> <span class="k">extends</span> <span class="nx">Middleware</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$except</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;set_test_date&#39;</span>
    <span class="p">];</span>
<span class="p">}</span>
</code></pre></div>

<h2>Conclusion</h2>
<p>It is possible to manipulate the current date in Laravel <em>end-to-end</em> tests using a middleware that accepts a <em>fake date</em> within a certain cookie and calling <code>Carbon::setTestNow()</code> for each request that has this cookie.</p>
<p>When using Cypress in a Laravel application, make sure to checkout out the <a href="https://github.com/laracasts/cypress">laracasts/cypress</a> helper package.</p>
<p>To learn more about Cypress in the context of Laravel applications, I can highly recommend <a href="https://laracasts.com/series/cypress-and-laravel-integration">this video series</a> on Laracasts.</p>
<hr>
<p>Photo by <a href="https://unsplash.com/@aronvisuals?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Aron Visuals</a> on <a href="https://unsplash.com/s/photos/date-time?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p>

<div class="sharing">
</div>
<hr>

	</section>
	<div class="clearfix"></div>

</article>

        </div>

        <!-- Sidebar -->
        <div class="four columns">




                
        </div>
			</div>
			<!-- Container / End -->
		</div>
		<!-- Content Wrapper / End -->

	<!-- Javascripts -->
	<script src="https://johnbraun.nl/theme/js/jquery.min.js"></script>
	</body>
</html>