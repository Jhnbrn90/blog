<!DOCTYPE html>
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<html lang="en">
<!--<![endif]-->
	<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="author" content="John Braun">


        <title>John Braun // Blog - OAuth2 authentication across Laravel projects</title>

        <!-- FAVICON -->
        <!-- CSS -->
        <link rel="stylesheet" href="https://johnbraun.nl/theme/css/style.css">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">

        <!-- Custom CSS -->
        	<link rel="stylesheet" href="https://johnbraun.nl/theme/css/colors/blue.css" id="colors">

        <!-- Code highlight color scheme -->
            <link href="https://johnbraun.nl/theme/css/code_blocks/darkly.css" rel="stylesheet">


        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->




    <meta property="og:type" content="article">
    <meta property="og:title" content="OAuth2 authentication across Laravel projects">
    <meta property="og:url" content="oauth2-authentication-across-laravel-projects.html">
    <meta property="og:description" content="Logging in to separate Laravel applications using a single account. This post discusses OAuth2, Laravel Passport and Laravel Socialite to set up such a system.">
    <meta property="article:published_time" content="Monday, December 09, 2019">
    <meta name="twitter:title" content="OAuth2 authentication across Laravel projects">
    <meta name="twitter:description" content="Logging in to separate Laravel applications using a single account. This post discusses OAuth2, Laravel Passport and Laravel Socialite to set up such a system.">
    <meta name="description" content="Logging in to separate Laravel applications using a single account. This post discusses OAuth2, Laravel Passport and Laravel Socialite to set up such a system.">
    <meta name="twitter:image" content="posts/oauth2-authentication-across-laravel-projects/cover.jpeg">
    <meta property="og:image" content="posts/oauth2-authentication-across-laravel-projects/cover.jpeg">
	          <meta property="og:locale" content="">
			<meta property="og:site_name" content="John Braun // Blog">

	<meta property="og:type" content="article">
	<meta property="article:author" content="">
	<meta property="og:url" content="https://johnbraun.nl/oauth2-authentication-across-laravel-projects.html">
	<meta property="og:title" content="OAuth2 authentication across Laravel projects">
	<meta property="og:description" content="">
       <meta property="og:image" content="https://johnbraun.nl/posts/oauth2-authentication-across-laravel-projects/cover.jpeg">
	<meta property="article:published_time" content="2019-12-09 00:00:00+01:00">
	</head>
	<body>
		<header id="header">
			<!-- Container -->
			<div class="container">
				<!-- Logo / Mobile Menu -->
				<div class="five columns">
					<div id="textlogo">
						<h1><a href="https://johnbraun.nl/">John Braun // Blog</a></h1>
					</div>
				</div>
						<!-- Navigation
				================================================== -->
				<div class="eleven columns">

					<nav id="navigation" class="menu">
						<ul id="responsive">

							<li><a href="https://johnbraun.nl/">Home</a></li>


							        <li><a href="https://johnbraun.nl/pages/about.html">About</a></li>
						</ul>
					</nav>
				</div>
			</div>
			<!-- Container / End -->
		</header>
		<!-- Header / End -->

		<!-- Breadcrumbs Container-->
		<div id="content-wrapper">
			<section id="titlebar">
				<!-- Container -->
				<div class="container">
				<div class="thirteen columns">
					<nav id="breadcrumbs">
						<ul>
							<li>You are here:</li>
							<li><a href="https://johnbraun.nl/">Home</a></li>
<li>OAuth2 authentication across Laravel projects</li>
						</ul>
					</nav>
				</div>
				</div>
				<!-- Container / End -->
			</section>

			<div class="container">
        <div class="twelve alt columns">
<article class="post" style="margin: 0; border: 0;">
	<section class="post-content">
		<header class="meta">
            <h2>
                <a href="https://johnbraun.nl/oauth2-authentication-across-laravel-projects.html">OAuth2 authentication across Laravel projects</a>
            </h2>
			<ul>
				<li>Published: 09-12-2019</li>
			</ul>
		</header>

		<h2>Introduction</h2>
<p>A question popping up every now and then is how to let users log in to separate (child) applications using a single account they own on a central application.</p>
<p>In this post I try to explain how to achieve this infrastructure, by creating a central application using <a href="https://laravel.com/docs/6.x/passport"><strong>Laravel Passport</strong></a> (<code>example.com</code>) where users register once and then use <a href="https://oauth.net/2/"><strong>OAuth2</strong></a> to grant access to their account to the other applications (<code>app1.example.com</code>, <code>app2.example.com</code>, etc.) using <a href="https://laravel.com/docs/6.x/socialite"><strong>Laravel Socialite</strong></a>. <em>Note: the applications do not necessarily have to use the same domain.</em></p>
<p>In this way, users will be able to login to the child applications without creating a new, separate account.</p>
<p><img alt="Authorization request (Laravel Passport)" src="images/posts/oauth2-authentication-across-laravel-projects/authorization-request.png"></p>
<p>If you're not yet familiar with the OAuth2 protocol, I've included a section on the how and what below. </p>
<hr>
<h2>What is OAuth2?</h2>
<p>Before jumping into Laravel Passport, it is important to understand the OAuth protocol it implements.</p>
<p>OAuth is an open standard, designed to provide <strong>API access delegation</strong>. Think of using a <strong>third party</strong> Twitter app which can tweet <strong>on your behalf</strong> to the Twitter platform. I explicitly mention <a href="https://www.twitter.com">Twitter</a> since development of this standard was (amongst others) driven by lead developer <a href="https://en.wikipedia.org/wiki/Blaine_Cook_(programmer)">Blane Cook</a>, in need of authorization of external parties.</p>
<p>After initial release of version 1.0 in 2010, the protocol matured over the course of 2 years after which version 2.0 was released. This improved protocol offers support for <strong>Bearer tokens</strong> and provides "specific <strong>authorization flows</strong> for web applications, desktop applications, mobile phones, and smart devices." (<a href="https://en.wikipedia.org/wiki/OAuth">Wikipedia</a>)</p>
<p>Let's have a look at what is meant with the terms <em>"Bearer token"</em> and <em>"authorization flow"</em> .</p>
<h3>Bearer Tokens</h3>
<p>The word "Bearer" means you're in possession of a certain (access) token. The bearer being the third party application, which possesses an <strong>access</strong> <strong>token</strong> issued by the <strong>identity provider</strong>. This token provides <strong>immediate access</strong> to a resource, without requiring a username and password. All necessary information is linked to this token, including user details and the <strong>scope</strong> of possible actions this third party may perform on behalf of this user.</p>
<p>The bearer token is usually included in the Headers of a GET or POST request to an API endpoint. A concrete example of using the Bearer token is shown below, making a GET request to '/api/user' using the <a href="http://docs.guzzlephp.org/en/stable/">Guzzle HTTP library</a> to a corresponding API endpoint sending along a Bearer Authorization header.</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="nv">$response</span> <span class="o">=</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/api/user&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;headers&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;Accept&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Authorization&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Bearer &#39;</span> <span class="o">.</span> <span class="nv">$accessToken</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">]);</span>
</code></pre></div>

<h3>Authorization Flow</h3>
<p>Now that we know what a Bearer access token is ... how do we obtain one?</p>
<p>First, let's look at the formal roles in OAuth2:</p>
<ul>
<li><strong>- Resource Owner</strong>: <em>the user who wants to login and delegate access to their account details to a third party application</em></li>
<li><strong>- Resource Server</strong>: <em>the server (API) where the user has an account</em></li>
<li><strong>- Client</strong>: <em>the third party application that wants to access the account information on the resource server</em></li>
</ul>
<p>The OAuth 2.0 protocol performs a standard communication flow between <strong>Client</strong> and <strong>Resource Server</strong>, where each step and given/required parameters are defined in advance. Ultimately, the <strong>Client</strong> receives the Bearer <strong>access token</strong> from the <strong>Resource server</strong>. This process is illustrated in the figure below (created using <a href="https://draw.io">draw.io</a>). Note: it is assumed that the <strong>Client</strong> (third party application) is registered with the <strong>Resource Server</strong>.</p>
<p><img alt="The OAuth authorization flow" src="images/posts/oauth2-authentication-across-laravel-projects/oauth-scheme.png"></p>
<p>After this little "dance", the <strong>Client</strong> now possesses an <strong>access token</strong> which can either be long-lived or short-lived (more secure). If the access token is <strong>short-lived</strong>, the <strong>Resource Server</strong> will also provide a <strong>refresh token</strong> which can be used - in combination with the <strong>client secret</strong> - to obtain a new access token in a way resembling Step 3 in the diagram above. <em>Note: the "state" parameter is used to prevent CSRF related attacks, by verifying the request is not forged.</em></p>
<p>Now, let's see how Laravel Passport implements this protocol.</p>
<hr>
<h2>Laravel Passport</h2>
<p>In case of our example, we want the <strong>identity provider</strong> (<code>example.com</code>) to make use of Laravel Passport.</p>
<p>Laravel Passport is an OAuth2 server, built upon the <a href="https://github.com/thephpleague/oauth2-server">League OAuth2 server</a>. It provides an easy implementation for existing Laravel applications by requiring the composer package.</p>
<h3>Setting up the Resource Server</h3>
<p>Follow the clear <a href="https://laravel.com/docs/6.x/passport#installation">installation instructions</a> and/or watch <a href="https://laracasts.com/series/whats-new-in-laravel-5-3/episodes/13">this explanation on Laracasts</a> by Taylor Otwell. Don't forget to add the <code>hasApiTokens</code> trait to your User model.</p>
<p>After installation, you now have the possiblity to add new <strong>Clients</strong> having a <strong>callback url</strong> and an automatically generated <strong>secret</strong>. For each of the "child" applications (<code>app1.example.com</code>, <code>app2.example.com</code>, etc.) you need to create a new <strong>Client</strong> with their own callback, for now you might choose <code>https://app1.example.com/login/callback</code> for example (we will come back to this).</p>
<p><img alt="Creating a new Client in Laravel Passport" src="images/posts/oauth2-authentication-across-laravel-projects/create-client.png"></p>
<p>Laravel Passport will take care of the authorization dialog, providing an authorization code, verifying the client secret in combination with the authorization code and lastly provide a <code>User</code> object and (by default) a <strong>long-lived</strong> access token. The lifespan of the access and refresh tokens are <a href="https://laravel.com/docs/6.x/passport#token-lifetimes">configurable</a>.</p>
<p><img alt="Example of a Client having an ID and a secret (in Laravel Passport)" src="images/posts/oauth2-authentication-across-laravel-projects/client-keys.png"></p>
<hr>
<h2>Laravel Socialite</h2>
<p>Now that we have set-up the <strong>Resource Server</strong> (identity provider), we need to take care of the <strong>Client</strong> side of things.</p>
<p>Besides Passport, Laravel offers a package called <a href="https://laravel.com/docs/6.x/socialite">Laravel Socialite</a>, which will take care of the <strong>Client</strong> side of things when authenticating via OAuth2.</p>
<p>Out of the box, it allows authentication with the services of <em>Facebook</em>, <em>Twitter</em>, <em>LinkedIn</em>, <em>Google</em>, <em>GitHub</em>, <em>GitLab</em> and <em>Bitbucket</em>.</p>
<h3>Socialite Providers</h3>
<p>However, there is a <a href="https://socialiteproviders.netlify.com/">collection of additional providers</a>, amongst which an adapter supporting <strong><em>Laravel Passport</em></strong>.</p>
<h3>Setting up the Client</h3>
<p>To achieve a shared login system across multiple Laravel applications, my proposed solution involves making use of the <a href="https://socialiteproviders.netlify.com/providers/laravel-passport.html">Socialite provider for Laravel Passport.</a></p>
<p>Looking at the installation instructions of the Socialite provider, there are quite a number of steps, to make sure a client application is able to identify users using the Laravel Passport identity provider.</p>
<ol>
<li>Install Laravel Socialite</li>
<li>Install Laravel Passport <strong>provider</strong> for Socialite</li>
<li>Add methods to LoginController</li>
<li>Copy the 'laravelpassport' <strong>config</strong> to config/services.php</li>
<li>Add 'SocialiteWasCalled' <strong>event</strong> and listener to EventServiceProvider</li>
</ol>
<p>Now, this seems like a lot of steps to repeat for every <strong>Client</strong> application we might already have and want to couple to our <strong>Resource Server</strong>. That's why I made a package (see <a href="https://github.com/jhnbrn90/socialite-passport">GitHub repository</a>) that combines Laravel Socialite with the Passport driver and can be configured in a more efficient way.</p>
<hr>
<h2>Socialite-Passport package</h2>
<p><img alt="Passport Socialite Repository" src="images/posts/oauth2-authentication-across-laravel-projects/passport-socialite-repository.png"></p>
<p>In a <strong>Client</strong> Laravel application that you want to couple to the Passport <strong>Resource Server</strong>, first install the custom <a href="https://github.com/jhnbrn90/socialite-passport">'socialite-passport' package</a>:</p>
<div class="highlight"><pre><span></span><code>composer<span class="w"> </span>require<span class="w"> </span>jhnbrn90/socialite-passport
</code></pre></div>

<p>Next, publish the configuration file:</p>
<div class="highlight"><pre><span></span><code>php<span class="w"> </span>artisan<span class="w"> </span>vendor:publish<span class="w"> </span>--provider<span class="o">=</span><span class="s2">&quot;JhnBrn90\SocialitePassport\SocialitePassportServiceProvider&quot;</span><span class="w"> </span>--tag<span class="o">=</span><span class="s2">&quot;config&quot;</span>﻿
</code></pre></div>

<p>This will publish a file <code>socialite-passport.php</code> in the <code>config</code> directory, in which you can define which Controller (defaults to <code>LoginController</code> that ships with Laravel) and which method should be called when the login route (also configurable) is called.</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">return</span> <span class="p">[</span>
    <span class="s1">&#39;controller&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="nx">\App\Http\Controllers\Auth\LoginController</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
        <span class="s1">&#39;method&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;loginWithPassport&#39;</span><span class="p">,</span>
    <span class="p">],</span>

    <span class="s1">&#39;route&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span>
        <span class="s1">&#39;uri&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;/login&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">];</span>
</code></pre></div>

<p>Assuming the defaults in the above configuration, after Authorization is granted by the <strong>Resource Owner</strong> at the <strong>Resource Server</strong> (Laravel Passport), the method <code>loginWithPassport()</code> will be called and a <code>User</code> object will be injected. This method needs to be implemented in the defined controller (in our example, the <code>LoginController</code>):</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">LoginController</span> <span class="k">extends</span> <span class="nx">Controller</span> 
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">loginWithPassport</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="c1">// example:</span>
        <span class="nx">User</span><span class="o">::</span><span class="na">firstOrCreate</span><span class="p">([</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="o">...</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>To be able to provide the <strong>Resource Server</strong> with a <code>client_id</code>, <code>callback_uri</code>, etc. you must add these variables to your <code>.env</code> file:</p>
<div class="highlight"><pre><span></span><code>LARAVELPASSPORT_CLIENT_ID=
LARAVELPASSPORT_CLIENT_SECRET=
LARAVELPASSPORT_REDIRECT_URI=/login/callback
LARAVELPASSPORT_HOST=https://example.com﻿
</code></pre></div>

<p>Remember, the <code>LARAVELPASSPORT_CLIENT_ID</code> and <code>LARAVELPASSPORT_CLIENT_SECRET</code> come from the Laravel Passport <strong>Resource Server</strong>, where the <strong>Client</strong> needs to be created first.</p>
<p>The package will make sure to match the route you provide as the <code>LARAVELPASSPORT_REDIRECT_URI</code> environment variable and proxies the request through the corresponding method and controller you've configured in the config file.</p>
<hr>
<h2>Conclusion</h2>
<p>That is all it takes to implement a basic functional shared login system.</p>
<p>I hope this post could shed some light on the OAuth2 protocol and how it can be used with the mentioned tools to achieve a shared authentication system amongst different Laravel projects.</p>
<p>It might be a good idea to also store the access token (and the resource token) on the user model to be able to update information whenever a user changes its profile on the <strong>Resource Server</strong>. Or to collect other data of that user from the Resource Server of course.</p>
<h3>Summary</h3>
<ul>
<li><a href="https://laravel.com/docs/6.x/passport">Laravel Passport</a> implements a fully functional OAuth2 server (Resource Server)</li>
<li><a href="https://laravel.com/docs/6.x/socialite">Laravel Socialite</a> implements a way to authenticate with an OAuth2 server (Client)</li>
<li>The <a href="https://socialiteproviders.netlify.com/providers/laravel-passport.html">Socialite provider</a> for Laravel Passport allows authentication with Laravel Passport</li>
<li>Clients can be prepared using <a href="https://github.com/jhnbrn90/socialite-passport">this package</a> combining both Socialite with the Passport adapter</li>
</ul>

<div class="sharing">
</div>
<hr>

	</section>
	<div class="clearfix"></div>

</article>

        </div>

        <!-- Sidebar -->
        <div class="four columns">




                
        </div>
			</div>
			<!-- Container / End -->
		</div>
		<!-- Content Wrapper / End -->

	<!-- Javascripts -->
	<script src="https://johnbraun.nl/theme/js/jquery.min.js"></script>
	</body>
</html>